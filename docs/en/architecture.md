# ğŸ— Architecture

[ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ° Ğ²ĞµÑ€ÑÑ–Ñ](../uk/architecture.md)

## System Overview

Health & Wellness Tracker is built on an event-driven architecture using n8n as the central orchestrator.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TELEGRAM WEB APP                            â”‚
â”‚                    (Frontend - React/Vue)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTPS
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TELEGRAM BOT                             â”‚
â”‚                    (Webhook Receiver)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ Webhook
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           n8n                                    â”‚
â”‚                 (Automation & Orchestration)                     â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Telegram   â”‚  â”‚   Voice     â”‚  â”‚   Food      â”‚              â”‚
â”‚  â”‚  Trigger    â”‚  â”‚  Processing â”‚  â”‚   Search    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   WHOOP     â”‚  â”‚   Daily     â”‚  â”‚   Data      â”‚              â”‚
â”‚  â”‚    Sync     â”‚  â”‚  Summary    â”‚  â”‚  Storage    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  FatSecret  â”‚ â”‚    WHOOP    â”‚ â”‚  PostgreSQL â”‚
    â”‚     API     â”‚ â”‚     API     â”‚ â”‚  Database   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚               â”‚               â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   OpenAI    â”‚
                    â”‚   (Whisper  â”‚
                    â”‚    + GPT)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Components

### 1. Telegram Web App

**Technologies:**
- React 18 + TypeScript
- Tailwind CSS
- Telegram Web App SDK

**Responsibilities:**
- UI rendering
- User interaction
- Sending commands to bot
- Real-time data display

### 2. n8n Workflows

**Main workflows:**

| Workflow | Trigger | Purpose |
|----------|---------|---------|
| Voice Processing | Telegram voice message | Process voice messages |
| Text Processing | Telegram text message | Process text messages |
| WHOOP Sync | Schedule (15 min) | Sync WHOOP data |
| Daily Summary | Schedule (21:00) | Generate daily report |
| Weekly Report | Schedule (Sunday) | Generate weekly report |

### 3. PostgreSQL Database

**Characteristics:**
- PostgreSQL 15+
- UUID for primary keys
- JSONB for flexible data
- Indexes for query optimization

**Main tables:**
- `users` - user profiles
- `food_entries` - food records
- `whoop_activities` - workouts
- `mood_entries` - mood records
- `daily_summaries` - daily summaries

---

## Data Flow

### Voice Food Logging

```
â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User â”‚â”€â”€â”€â–¶â”‚ Telegram â”‚â”€â”€â”€â–¶â”‚   n8n    â”‚â”€â”€â”€â–¶â”‚ OpenAI   â”‚
â”‚      â”‚    â”‚   Bot    â”‚    â”‚          â”‚    â”‚ Whisper  â”‚
â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚               â”‚
                                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚         Text
                                 â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  OpenAI  â”‚â”€â”€â”€â–¶â”‚ FatSecretâ”‚
                           â”‚   GPT    â”‚    â”‚   API    â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚               â”‚
                                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚       Calories
                                 â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚ PostgreSQLâ”‚â—€â”€â”€â”‚   n8n    â”‚
                           â”‚          â”‚    â”‚          â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ Telegram â”‚
                                          â”‚ Response â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security

### Authentication

- **Telegram:** Uses `initData` for user verification
- **WHOOP:** OAuth 2.0 tokens stored encrypted
- **FatSecret:** Client credentials, no user tokens stored

### Secret Storage

All secrets stored in environment variables and n8n encrypted credentials storage.

### GDPR Compliance

- User can export all their data
- User can delete account and all data
- Minimal data collection
- Data not shared with third parties

---

## Deployment

### Docker Compose

```yaml
version: '3.8'

services:
  n8n:
    image: n8nio/n8n
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=db
    ports:
      - "5678:5678"
    depends_on:
      - db

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=healthlog
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

  web:
    build: ./webapp
    ports:
      - "3000:3000"

volumes:
  postgres_data:
```

### Dokploy

The system can be deployed via Dokploy:

1. Create a new project
2. Add PostgreSQL service
3. Add n8n as Docker application
4. Configure environment variables
5. Set up domain and SSL

---

## Monitoring

### Metrics

| Metric | Description | Threshold |
|--------|-------------|-----------|
| API Response Time | Response time | < 5 sec |
| Sync Success Rate | % successful syncs | > 99% |
| Error Rate | % errors | < 1% |
| Active Users | DAU/MAU | - |

### Logging

- n8n execution logs
- PostgreSQL query logs
- API error tracking

---

## Scaling

### Horizontal Scaling

Multiple n8n instances behind a load balancer with PostgreSQL primary/replica setup.

### Caching

- Redis for sessions and API cache
- CDN for Web App static files
