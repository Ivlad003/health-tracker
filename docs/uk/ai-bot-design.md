# AI Health Bot — Дизайн-документ

[English version](../en/ai-bot-design.md)

> Результат брейнштормінгу (2026-02-24). Визначає розмовний AI Telegram-бот, побудований на існуючій інфраструктурі Health Tracker.

---

## 1. Огляд

Вільний, двомовний (UK/EN) Telegram-бот на базі OpenAI GPT, який працює як персональний асистент здоров'я. Користувачі спілкуються природною мовою, GPT розуміє наміри, а n8n оркеструє дії за лаштунками.

**Це чистий Telegram чат-бот** — без Web App фронтенду. Вся взаємодія через текстові та голосові повідомлення.

---

## 2. Дизайн-рішення

| # | Аспект | Рішення |
|---|--------|---------|
| 1 | Інтерфейс | Чистий Telegram-бот, вільна природна мова |
| 2 | AI | OpenAI — Whisper (STT) + GPT (один виклик: намір + відповідь) |
| 3 | Мова | Двомовний UK/EN, GPT автоматично визначає та перекладає для FatSecret |
| 4 | Логування їжі | Повністю автоматичне, спочатку FatSecret, GPT як запасний варіант, відповідь з підсумками |
| 5 | Розмова | Контекст за весь день, збережений в БД |
| 6 | Проактивність | Ранковий брифінг (8:00) + Вечірній підсумок (21:00) |
| 7 | Калорії | Проста математика: вжито - витрачено |
| 8 | Архітектура | 5 окремих n8n воркфлоу (3 нових + 2 існуючих) |

---

## 3. Особистість бота та приклади взаємодії

Бот відповідає розмовно, повідомляючи про свої дії:

> **Користувач:** "Я з'їв курячу грудку з рисом на обід, грам 300 загалом"
> **Бот:** "Записав: курка гриль 200г (330 kcal, 62g білка) + рис білий 100г (130 kcal, 27g вуглеводів). Сьогодні: 1,240 / 2,200 kcal"

> **Користувач:** "І ще каву з молоком"
> **Бот:** "Записав: кава з молоком (50 kcal). Сьогодні: 1,290 / 2,200 kcal"

> **Користувач:** "Як я спав?"
> **Бот:** "Минула ніч: 7г 12хв, оцінка сну 82. Глибокий сон 1г 45хв (добре). Відновлення 71% — помірний день, не перевантажуйся."

Англійський приклад:

> **User:** "I ate chicken breast with rice for lunch, about 300 grams total"
> **Bot:** "Logged: grilled chicken 200g (330 kcal, 62g protein) + white rice 100g (130 kcal, 27g carbs). Today: 1,240 / 2,200 kcal"

---

## 4. Архітектура n8n воркфлоу (5 воркфлоу)

### 4.1 Telegram Message Handler (НОВИЙ)

Головний мозок бота. Обробляє всі вхідні повідомлення.

```
Telegram Trigger (webhook)
  ├── Голос? -> Whisper STT -> текст
  └── Текст? -> використати напряму
         │
         v
Завантажити контекст розмови (останній день з БД)
         │
         v
GPT один виклик (системний промпт + контекст + повідомлення)
  -> Повертає JSON: { intent, food_items[], response }
         │
         ├── intent: log_food
         │     -> Пошук FatSecret по кожному продукту
         │     -> GPT оцінка якщо не знайдено
         │     -> INSERT в food_entries
         │     -> Відповідь з підсумками
         │
         ├── intent: query_data
         │     -> SELECT з БД (сон/їжа/whoop)
         │     -> Відповідь з аналізом
         │
         ├── intent: delete_entry
         │     -> DELETE останній food_entry
         │     -> Підтвердження видалення
         │
         └── intent: general
               -> Відповідь від GPT

Зберегти повідомлення + відповідь в conversation_messages
```

### 4.2 Morning Briefing (НОВИЙ — за розкладом 8:00 Київ)

```
Schedule Trigger -> Для кожного користувача:
  -> Запит сну + відновлення за минулу ніч (WHOOP)
  -> Запит балансу калорій за вчора
  -> GPT: згенерувати ранкову пораду на основі даних
  -> Надіслати повідомлення в Telegram
```

**Зміст:**
- Оцінка сну + тривалість минулої ночі (WHOOP)
- Оцінка відновлення (WHOOP)
- Баланс калорій за вчора
- Одна порада на день

### 4.3 Evening Summary (НОВИЙ — за розкладом 21:00 Київ)

```
Schedule Trigger -> Для кожного користувача:
  -> Запит food_entries за сьогодні (страви + підсумки)
  -> Запит тренувань WHOOP + спалені калорії
  -> Розрахувати профіцит/дефіцит
  -> GPT: згенерувати вечірню рефлексію + пораду
  -> Надіслати повідомлення в Telegram
```

**Зміст:**
- Загальні калорії за сьогодні (вжито)
- Загальні спалені калорії (WHOOP)
- Профіцит/дефіцит калорій
- Страви за сьогодні
- Одна рефлексія/порада

### 4.4 WHOOP Data Sync (ІСНУЮЧИЙ — щогодини)

ID воркфлоу: `nAjGDfKdddSDH2MD` — вже активний і працює.

### 4.5 FatSecret Food Search (ІСНУЮЧИЙ — webhook)

ID воркфлоу: `qTHRcgiqFx9SqTNm` — вже активний на `/webhook/food/search?q=`.

---

## 5. Нова таблиця БД: `conversation_messages`

```sql
CREATE TABLE conversation_messages (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    role VARCHAR(20) NOT NULL,        -- 'user' або 'assistant'
    content TEXT NOT NULL,
    intent VARCHAR(50),               -- класифікований намір
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_conv_user_date
    ON conversation_messages(user_id, created_at);
```

- Контекст за весь день завантажується для кожного виклику GPT
- Старі повідомлення автоочищуються (зберігати 7 днів)

---

## 6. GPT системний промпт (дизайн одного виклику)

```
You are a health assistant bot. Analyze the user's message and:

1. Classify intent: log_food | query_data | delete_entry | general
2. If log_food: extract food items with quantities
3. Generate a friendly response in the user's language

Respond in JSON:
{
  "intent": "log_food",
  "food_items": [
    {"name_en": "chicken breast", "name_original": "куряча грудка", "quantity_g": 200},
    {"name_en": "white rice", "name_original": "рис", "quantity_g": 100}
  ],
  "response": "Записав: курка 200г + рис 100г. Шукаю калорії..."
}

Context: user's conversation history and health data are provided.
```

---

## 7. Ключові технічні нотатки

### Двомовна обробка
- GPT автоматично визначає мову з повідомлення
- Назви продуктів перекладаються англійською для FatSecret API
- Відповідь надсилається мовою користувача
- Whisper автоматично визначає мову (можна підказати `uk` або `en` з налаштувань Telegram)

### Конвеєр пошуку їжі
1. GPT витягує продукти з англійськими назвами
2. Пошук FatSecret для кожного продукту
3. Якщо FatSecret не знаходить -> GPT оцінює калорії з власних знань
4. Всі записи зберігаються в таблицю `food_entries`

### Контекст розмови
- Всі повідомлення зберігаються в таблиці `conversation_messages`
- Кожен виклик GPT завантажує розмову за весь день
- Підтримка багатоповідомлень: "Я з'їв курку" -> "І рис до неї" -> бот розуміє обидва

### Обмеження n8n (v2.35.5)
- Використовувати точні значення `typeVersion` з `session-knowledge.md`
- Тільки синтаксис Code node v1
- Неможливо використати `require('crypto')` в Code nodes

---

## 8. Відкриті питання / Ризики

1. **FatSecret OAuth1 все ще заблокований** — синхронізація щоденника їжі не працюватиме поки IP whitelist не поширяться. Пошук їжі (OAuth2) працює зараз.
2. **Витрати OpenAI** — контекст за весь день на кожне повідомлення може коштувати ~$1-3/день для персонального бота.
3. **Стан розмови в n8n** — n8n не призначений для stateful розмов. Підхід через БД працює, але додає затримку на кожне повідомлення.
4. **Визначення мови Whisper** — автовизначення працює, але підказка `uk` або `en` покращує точність.
5. **Ризик SQL-ін'єкцій** — забезпечити параметризовані запити в n8n Store нодах (без конкатенації рядків для контенту користувача).
