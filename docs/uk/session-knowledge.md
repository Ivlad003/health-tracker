# –ë–∞–∑–∞ –∑–Ω–∞–Ω—å —Å–µ—Å—ñ—ó - 2026-02-25

[English version](../en/session-knowledge.md)

> –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–Ω–∞–Ω–Ω—è, –æ—Ç—Ä–∏–º–∞–Ω—ñ –ø—ñ–¥ —á–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è Health Tracker –±–æ—Ç–∞.
> –¶–µ–π —Ñ–∞–π–ª —î –¥–æ–≤—ñ–¥–Ω–∏–∫–æ–º –¥–ª—è –º–∞–π–±—É—Ç–Ω—ñ—Ö —Å–µ—Å—ñ–π —Ä–æ–∑—Ä–æ–±–∫–∏.

---

## 1. –§–∞–∫—Ç–∏ –ø—Ä–æ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É

| –†–µ—Å—É—Ä—Å | –ó–Ω–∞—á–µ–Ω–Ω—è |
|--------|----------|
| –î–æ–¥–∞—Ç–æ–∫ | FastAPI Python 3.12+ (Docker –Ω–∞ Dokploy) |
| PostgreSQL | –î–∏–≤. `.env` -> `DATABASE_URL` |
| Dokploy –ø–∞–Ω–µ–ª—å | –î–∏–≤. `.mcp.json` -> `mcpServers.dokploy-mcp.env.DOKPLOY_URL` |
| WHOOP user ID | –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –∫–æ–ª–æ–Ω—Ü—ñ `users.whoop_user_id` |
| Telegram user ID | –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –∫–æ–ª–æ–Ω—Ü—ñ `users.telegram_user_id` |

### –°–µ—Ä–≤—ñ—Å–∏ –¥–æ–¥–∞—Ç–∫—É

| –°–µ—Ä–≤—ñ—Å | –§–∞–π–ª | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|--------|------|-------------|
| Telegram Bot | `app/services/telegram_bot.py` | –û–±—Ä–æ–±–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, –∫–æ–º–∞–Ω–¥–∏ (/start, /help, /sync, /connect_whoop, /connect_fatsecret) |
| AI Assistant | `app/services/ai_assistant.py` | GPT –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—è + –≤—ñ–¥–ø–æ–≤—ñ–¥—å, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–ª–æ—Ä—ñ–π |
| WHOOP Sync | `app/services/whoop_sync.py` | OAuth 2.0, —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö, –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ |
| FatSecret API | `app/services/fatsecret_api.py` | OAuth 1.0, –ø–æ—à—É–∫ —ó–∂—ñ, —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —â–æ–¥–µ–Ω–Ω–∏–∫–∞, –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω—ñ–≤ |
| FatSecret Auth | `app/services/fatsecret_auth.py` | OAuth 1.0 HMAC-SHA1 –ø—ñ–¥–ø–∏—Å–∞–Ω–Ω—è |
| Briefings | `app/services/briefings.py` | –†–∞–Ω–∫–æ–≤—ñ (08:00) / –≤–µ—á—ñ—Ä–Ω—ñ (21:00) –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è |
| Scheduler | `app/scheduler.py` | APScheduler –ø–µ—Ä—ñ–æ–¥–∏—á–Ω—ñ –∑–∞–¥–∞—á—ñ |

### –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ –∑–∞–¥–∞—á—ñ

| –ó–∞–¥–∞—á–∞ | –ß–∞—Å—Ç–æ—Ç–∞ | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|--------|---------|-------------|
| WHOOP Data Sync | –ö–æ–∂–Ω—É 1–≥ | –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Ç—Ä–µ–Ω—É–≤–∞–Ω—å, —Å–Ω—É, –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è |
| WHOOP Token Refresh | –ö–æ–∂–Ω—ñ 30—Ö–≤ | –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ |
| FatSecret Data Sync | –ö–æ–∂–Ω—É 1–≥ | –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —â–æ–¥–µ–Ω–Ω–∏–∫–∞ —ó–∂—ñ |
| FatSecret Token Check | –ö–æ–∂–Ω—ñ 30—Ö–≤ | –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω—ñ–≤, —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—ñ |
| Morning Briefing | 08:00 Europe/Kyiv | –†–∞–Ω–∫–æ–≤–∏–π –æ–≥–ª—è–¥ –∑–¥–æ—Ä–æ–≤'—è |
| Evening Summary | 21:00 Europe/Kyiv | –í–µ—á—ñ—Ä–Ω—ñ–π –∑–≤—ñ—Ç |
| Conversation Cleanup | 03:00 UTC | –û—á–∏—â–µ–Ω–Ω—è —Å—Ç–∞—Ä–æ—ó —ñ—Å—Ç–æ—Ä—ñ—ó —Ä–æ–∑–º–æ–≤ |

---

## 2. WHOOP API - –ö—Ä–∏—Ç–∏—á–Ω—ñ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è

### –í–µ—Ä—Å—ñ—è API: –¢–Ü–õ–¨–ö–ò v2

**WHOOP API –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î v2, –ù–ï v1.** –í—Å—ñ v1 –µ–Ω–¥–ø–æ—ñ–Ω—Ç–∏ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å 404.

| –ï–Ω–¥–ø–æ—ñ–Ω—Ç | URL |
|----------|-----|
| –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è | `GET /developer/v2/activity/workout` |
| –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è | `GET /developer/v2/recovery` |
| –°–æ–Ω | `GET /developer/v2/activity/sleep` |
| –î–µ–Ω–Ω–∏–π —Ü–∏–∫–ª | `GET /developer/v2/cycle` |
| –û–±–º—ñ–Ω —Ç–æ–∫–µ–Ω—ñ–≤ | `POST /oauth/oauth2/token` |
| –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è | `GET /oauth/oauth2/auth` |

### –î–æ—Å—Ç—É–ø–Ω—ñ —Å–∫–æ—É–ø–∏ (–ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω—ñ —Ç–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω—ñ)

```
read:workout read:recovery read:sleep read:body_measurement
```

**–°–∫–æ—É–ø–∏, —è–∫—ñ –ù–ï –ø—Ä–∞—Ü—é—é—Ç—å:**
- `read:cycles` - –ø–æ–≤–µ—Ä—Ç–∞—î –ø–æ–º–∏–ª–∫—É `invalid_scope`
- `read:profile` - –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–ª—è —Ü—å–æ–≥–æ –¥–æ–¥–∞—Ç–∫—É; v1 profile –µ–Ω–¥–ø–æ—ñ–Ω—Ç –ø–æ–≤–µ—Ä—Ç–∞—î 401

### –î–∞–Ω—ñ –ø—Ä–æ –∫—Ä–æ–∫–∏ –ù–ï –¥–æ—Å—Ç—É–ø–Ω—ñ —á–µ—Ä–µ–∑ API

WHOOP –≤—ñ–¥—Å—Ç–µ–∂—É—î –∫—Ä–æ–∫–∏ –≤ –¥–æ–¥–∞—Ç–∫—É (–¥–æ–¥–∞–Ω–æ 2025), –∞–ª–µ Developer API v2 **–Ω–µ –Ω–∞–¥–∞—î** –¥–∞–Ω—ñ –ø—Ä–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫—Ä–æ–∫—ñ–≤. –ù–µ–º–∞—î –µ–Ω–¥–ø–æ—ñ–Ω—Ç—É –∞–±–æ –ø–æ–ª—è –¥–ª—è –∫—Ä–æ–∫—ñ–≤. –°–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç –±–æ—Ç–∞ –Ω–∞–ø—Ä–∞–≤–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –∫—Ä–æ–∫–∏ –≤ –¥–æ–¥–∞—Ç–∫—É WHOOP.

### –ñ–∏—Ç—Ç—î–≤–∏–π —Ü–∏–∫–ª —Ç–æ–∫–µ–Ω–∞

- Access token –¥—ñ—î **3600 —Å–µ–∫—É–Ω–¥ (1 –≥–æ–¥–∏–Ω–∞)**
- Refresh token –¥–æ–≤–≥–æ—Ç—Ä–∏–≤–∞–ª–∏–π
- –û–Ω–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ `POST /oauth/oauth2/token` –∑ `grant_type=refresh_token`
- –ü–æ—Ç—Ä—ñ–±–Ω—ñ –ª–∏—à–µ `client_id` —Ç–∞ `client_secret` (–±–µ–∑ `redirect_uri`)
- **–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞ –º–æ–∂–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ 400 Bad Request** —è–∫—â–æ —Ç–æ–∫–µ–Ω –±—É–ª–æ –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–æ. –û–±—Ä–æ–±–∫–∞: –æ—á–∏—â–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ + `TokenExpiredError`.

### OAuth Flow - –†–æ–±–æ—á–∞ URL –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó

```
https://api.prod.whoop.com/oauth/oauth2/auth?client_id={WHOOP_CLIENT_ID}&redirect_uri={WHOOP_REDIRECT_URI}&response_type=code&scope=read:workout%20read:recovery%20read:sleep%20read:body_measurement&state={TELEGRAM_USER_ID}
```

> –ó–Ω–∞—á–µ–Ω–Ω—è `WHOOP_CLIENT_ID` —Ç–∞ `WHOOP_REDIRECT_URI` –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –≤ `.env`.

### –û—Ç—Ä–∏–º–∞–Ω–Ω—è User ID –±–µ–∑ `read:profile`

–û—Å–∫—ñ–ª—å–∫–∏ profile –µ–Ω–¥–ø–æ—ñ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, user_id –≤–∏—Ç—è–≥—É—î—Ç—å—Å—è –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ recovery:
```
GET /developer/v2/recovery?limit=1 -> response.records[0].user_id
```

### –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤

`refresh_token_if_needed()` –≤ `whoop_sync.py`:
- –ú–∞—î –ø–∞—Ä–∞–º–µ—Ç—Ä `force` –¥–ª—è –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
- –ü—Ä–∏ 400/401/403 –≤—ñ–¥ token endpoint: –æ—á–∏—â—É—î —Ç–æ–∫–µ–Ω–∏ –∑ –ë–î, –∫–∏–¥–∞—î `TokenExpiredError`
- –í—Å—ñ –≤–∏–∫–ª–∏–∫–∏ WHOOP API –º–∞—é—Ç—å –ª–æ–≥—ñ–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É –ø—Ä–∏ 401 (force-refresh + retry)

---

## 3. FatSecret API - –ö—Ä–∏—Ç–∏—á–Ω—ñ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è

### –î–≤–∞ —Ä—ñ–∑–Ω–∏—Ö –Ω–∞–±–æ—Ä–∏ credentials

FatSecret –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **—Ä—ñ–∑–Ω—ñ credentials** –¥–ª—è OAuth 1.0 —Ç–∞ OAuth 2.0:

| | OAuth 2.0 | OAuth 1.0 |
|---|---|---|
| –ù–∞–∑–≤–∞ –∫–ª—é—á–∞ | Client ID | Consumer Key |
| –ù–∞–∑–≤–∞ —Å–µ–∫—Ä–µ—Ç—É | Client Secret | Shared Secret |
| –ó–Ω–∞—á–µ–Ω–Ω—è | –û–¥–Ω–∞–∫–æ–≤–∏–π –∫–ª—é—á, **—Ä—ñ–∑–Ω—ñ —Å–µ–∫—Ä–µ—Ç–∏** | –û–¥–Ω–∞–∫–æ–≤–∏–π –∫–ª—é—á, **—Ä—ñ–∑–Ω—ñ —Å–µ–∫—Ä–µ—Ç–∏** |
| –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è | –ü—É–±–ª—ñ—á–Ω–∞ –±–∞–∑–∞ –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ (–ø–æ—à—É–∫) | –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π —â–æ–¥–µ–Ω–Ω–∏–∫ —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è |

### OAuth 2.0 (Server-to-Server) - –ü–†–ê–¶–Æ–Ñ

- Token: `POST https://oauth.fatsecret.com/connect/token`
- API: `POST https://platform.fatsecret.com/rest/server.api`
- –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è: –ø–æ—à—É–∫ –ø—Ä–æ–¥—É–∫—Ç—ñ–≤, –¥–µ—Ç–∞–ª—ñ –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ (–ø—É–±–ª—ñ—á–Ω–∞ –±–∞–∑–∞)
- **–ü–æ—Ç—Ä–µ–±—É—î IP whitelist** –Ω–∞ `platform.fatsecret.com`

### OAuth 1.0 Three-Legged (–¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞) - –ü–†–ê–¶–Æ–Ñ

–î–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ —â–æ–¥–µ–Ω–Ω–∏–∫–∞ —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è.

**–ï–Ω–¥–ø–æ—ñ–Ω—Ç–∏:**
- Request Token: `POST https://authentication.fatsecret.com/oauth/request_token`
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è: `GET https://authentication.fatsecret.com/oauth/authorize?oauth_token={token}`
- Access Token: `POST https://authentication.fatsecret.com/oauth/access_token`

**–ü—ñ–¥–ø–∏—Å–∞–Ω–Ω—è:** HMAC-SHA1 —á–µ—Ä–µ–∑ `app/services/fatsecret_auth.py`

**–ü–æ–≤–µ–¥—ñ–Ω–∫–∞ —Ç–æ–∫–µ–Ω—ñ–≤:** OAuth 1.0 —Ç–æ–∫–µ–Ω–∏ **–ø–æ—Å—Ç—ñ–π–Ω—ñ** ‚Äî –Ω–µ –∑–∞–∫—ñ–Ω—á—É—é—Ç—å—Å—è, —è–∫—â–æ –Ω–µ –≤—ñ–¥–∫–ª–∏–∫–∞–Ω—ñ. –ù–µ–º–∞—î –º–µ—Ö–∞–Ω—ñ–∑–º—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—è. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–∂–Ω—ñ 30 —Ö–≤ –≤–∞–ª—ñ–¥—É—î —Ç–æ–∫–µ–Ω–∏ —á–µ—Ä–µ–∑ –≤–∏–∫–ª–∏–∫ API.

### FatSecret –ø–æ–≤–µ—Ä—Ç–∞—î HTTP 200 –¥–ª—è –ø–æ–º–∏–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó

**–ö–†–ò–¢–ò–ß–ù–û:** FatSecret –ø–æ–≤–µ—Ä—Ç–∞—î `HTTP 200 OK` –∑ `{"error": {"code": X, "message": "..."}}` –≤ —Ç—ñ–ª—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –¥–ª—è –ø–æ–º–∏–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó ‚Äî –ù–ï HTTP 401/403. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π `httpx.HTTPStatusError` —Ü–µ –Ω–µ –∑–ª–æ–≤–∏—Ç—å.

**–†—ñ—à–µ–Ω–Ω—è:** –ö–∞—Å—Ç–æ–º–Ω–∏–π `FatSecretAuthError` + `_FS_AUTH_ERROR_CODES = {2, 4, 8, 13, 14}` –≤ `fatsecret_api.py`. –í—Å—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ API –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å—Å—è –Ω–∞ error body.

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –¥–∂–µ—Ä–µ–ª–∞ –∫–∞–ª–æ—Ä—ñ–π

–ö–æ–ª–∏ FatSecret –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π —ñ –ø—Ä–∞—Ü—é—î, –≤—ñ–Ω —î **–¥–∂–µ—Ä–µ–ª–æ–º —ñ—Å—Ç–∏–Ω–∏** –¥–ª—è –∑'—ó–¥–µ–Ω–∏—Ö –∫–∞–ª–æ—Ä—ñ–π (–∑–∞–ø–∏—Å–∏ –±–æ—Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—é—Ç—å—Å—è —Ç—É–¥–∏). Bot-logged –∫–∞–ª–æ—Ä—ñ—ó –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è —è–∫ fallback –∫–æ–ª–∏ FatSecret –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π. –î–∏–≤. `get_today_stats()` –≤ `ai_assistant.py`.

---

## 4. –°—Ö–µ–º–∞ –ë–î - –†–µ–∞–ª—å–Ω—ñ—Å—Ç—å vs –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

### –ö–†–ò–¢–ò–ß–ù–û: –Ü—Å–Ω—É—é—á–∞ –ë–î –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î INTEGER, –∞ –Ω–µ UUID

```sql
-- –§–∞–∫—Ç–∏—á–Ω–∞ —Å—Ö–µ–º–∞:
users.id          -> INTEGER (SERIAL), –ù–ï UUID
users.telegram_user_id -> BIGINT
```

–ú—ñ–≥—Ä–∞—Ü—ñ—è `001_initial_schema.sql` –º–∞—î UUID-—Å—Ö–µ–º—É, –∞–ª–µ **–Ω—ñ–∫–æ–ª–∏ –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞–ª–∞—Å—å**. –ú—ñ–≥—Ä–∞—Ü—ñ—è `002_health_tracker_schema.sql` –ø—Ä–∞—Ü—é—î –∑ —ñ—Å–Ω—É—é—á–æ—é INTEGER-—Å—Ö–µ–º–æ—é.

### –¢–∞–±–ª–∏—Ü—ñ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω—ñ

`users`, `diary_entries`, `food_entries`, `mood_entries`, `whoop_activities`, `whoop_recovery`, `whoop_sleep`, `daily_summaries`, `sync_logs`, `conversation_messages`

---

## 5. GPT Context Engineering

### –£–Ω–∏–∫–∞–π—Ç–µ —Å–∫–ª–∞–¥–Ω–∏—Ö —Ä–æ–∑–±–∏–≤–æ–∫ –¥–ª—è GPT

**–ë–∞–≥ –∑–Ω–∞–π–¥–µ–Ω–æ 2026-02-25:** –ö–æ–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç GPT –ø–æ–∫–∞–∑—É–≤–∞–≤ "total: 216 kcal (FatSecret: 216, bot: 40)", GPT –¥–æ–¥–∞–≤–∞–≤ —ó—Ö —ñ –æ—Ç—Ä–∏–º—É–≤–∞–≤ 256 –∑–∞–º—ñ—Å—Ç—å 216.

**–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:** –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –û–î–ù–ï —á–∏—Å–ª–æ –∑ —è–≤–Ω–æ—é —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—î—é:
```
Today's calories eaten: {total} kcal.
IMPORTANT: Use ONLY these exact numbers when answering about calories.
Do NOT add or recalculate ‚Äî these are already the correct totals.
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç—É

`SYSTEM_PROMPT` –≤ `ai_assistant.py` –∫–ª–∞—Å–∏—Ñ—ñ–∫—É—î –∫–æ–∂–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:
- `log_food` ‚Äî –≤–∏—Ç—è–≥—É—î –ø—Ä–æ–¥—É–∫—Ç–∏ –∑ –Ω–∞–∑–≤–æ—é, –≤–∞–≥–æ—é, —Ç–∏–ø–æ–º –ø—Ä–∏–π–æ–º—É —ó–∂—ñ
- `query_data` ‚Äî –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –ø—Ä–æ –¥–∞–Ω—ñ –∑–¥–æ—Ä–æ–≤'—è –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
- `delete_entry` ‚Äî –≤–∏–¥–∞–ª—è—î –æ—Å—Ç–∞–Ω–Ω—ñ–π/–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –∑–∞–ø–∏—Å —ó–∂—ñ
- `general` ‚Äî –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è, –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü—ñ–ª—ñ –∫–∞–ª–æ—Ä—ñ–π, –¥–æ–ø–æ–º–æ–≥–∞

–í—ñ–¥–ø–æ–≤—ñ–¥—å –∑–∞–≤–∂–¥–∏ JSON –∑ –ø–æ–ª—è–º–∏ `intent`, `food_items`, `calorie_goal`, `response`.

---

## 6. –¢–∏–ø–æ–≤—ñ –ø–æ–º–∏–ª–∫–∏ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### –ü–∞—Ä—Å–∏–Ω–≥ .env —É Bash

`source <(grep ...)` —Ç–∞ `export $(cat ... | xargs)` **–ø–∞–¥–∞—é—Ç—å** –∫–æ–ª–∏ –ø–∞—Ä–æ–ª—å –º—ñ—Å—Ç–∏—Ç—å —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∏. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ü–∏–∫–ª `while IFS= read -r line` (–¥–∏–≤. `database/init-db.sh`).

### PostgreSQL DATE() –Ω–∞ TIMESTAMPTZ –ù–ï —î immutable

```sql
-- –ü–ê–î–ê–Ñ: DATE() –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ timezone
CREATE INDEX idx ON food_entries(user_id, DATE(logged_at));

-- –ü–†–ê–¶–Æ–Ñ: –∫–æ–º–ø–æ–∑–∏—Ç–Ω–∏–π —ñ–Ω–¥–µ–∫—Å, —Ñ—ñ–ª—å—Ç—Ä —É –∑–∞–ø–∏—Ç–∞—Ö
CREATE INDEX idx ON food_entries(user_id, logged_at);
```

### –ü–∞—Ç–µ—Ä–Ω–∏ –¥–µ—Ç–µ–∫—Ü—ñ—ó –ø—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤

**WHOOP (OAuth 2.0):** –¢–æ–∫–µ–Ω –º–∞—î –≤—ñ–¥–æ–º–∏–π —á–∞—Å –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è. `refresh_token_if_needed()` –ø–µ—Ä–µ–≤—ñ—Ä—è—î `whoop_token_expires_at`. –ü—Ä–∏ 401 –≤—ñ–¥ API: force-refresh + retry. –ü—Ä–∏ –Ω–µ–≤–¥–∞–ª–æ–º—É refresh (400/401/403): –æ—á–∏—â–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤, `TokenExpiredError`.

**FatSecret (OAuth 1.0):** –¢–æ–∫–µ–Ω–∏ –ø–æ—Å—Ç—ñ–π–Ω—ñ, –∞–ª–µ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤—ñ–¥–∫–ª–∏–∫–∞–Ω—ñ. API –ø–æ–≤–µ—Ä—Ç–∞—î HTTP 200 –∑ error body. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ `_FS_AUTH_ERROR_CODES` —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ. –ü—Ä–∏ auth –ø–æ–º–∏–ª—Ü—ñ: –æ—á–∏—â–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤, `FatSecretAuthError`, —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Telegram.

### –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –ø—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω—ñ —Ç–æ–∫–µ–Ω–∏

`handle_message` —Ç–∞ `handle_sync` –≤ `telegram_bot.py` –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å `expired_services` –∑ `get_today_stats()` —ñ –¥–æ–¥–∞—é—Ç—å –ø—ñ–¥–∫–∞–∑–∫–∏:
```
üîë –°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—å, –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–∏—Ç–∏:
  ‚åö WHOOP ‚Üí /connect_whoop
  ü•ó FatSecret ‚Üí /connect_fatsecret
```

---

## 7. –î–æ–≤—ñ–¥–Ω–∏–∫ —Ñ–∞–π–ª—ñ–≤

| –§–∞–π–ª | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|------|-------------|
| `app/main.py` | –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É FastAPI, —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∂–∏—Ç—Ç—î–≤–∏–º —Ü–∏–∫–ª–æ–º |
| `app/config.py` | –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑—ñ –∑–º—ñ–Ω–Ω–∏—Ö –æ—Ç–æ—á–µ–Ω–Ω—è |
| `app/database.py` | asyncpg –ø—É–ª –∑'—î–¥–Ω–∞–Ω—å PostgreSQL |
| `app/scheduler.py` | –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–∏—Ö –∑–∞–¥–∞—á APScheduler |
| `app/services/telegram_bot.py` | –í—Å—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –±–æ—Ç–∞ —Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è |
| `app/services/ai_assistant.py` | GPT —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–ª–æ—Ä—ñ–π, –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–æ–∑–º–æ–≤–∏ |
| `app/services/whoop_sync.py` | WHOOP OAuth 2.0, —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è, —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞–º–∏ |
| `app/services/fatsecret_api.py` | FatSecret API, —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —â–æ–¥–µ–Ω–Ω–∏–∫–∞, –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω—ñ–≤ |
| `app/services/fatsecret_auth.py` | OAuth 1.0 HMAC-SHA1 –ø—ñ–¥–ø–∏—Å–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤ |
| `app/services/briefings.py` | –†–∞–Ω–∫–æ–≤—ñ/–≤–µ—á—ñ—Ä–Ω—ñ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è |
| `app/routers/whoop.py` | `/whoop/callback` OAuth flow |
| `app/routers/fatsecret.py` | `/fatsecret/connect`, `/fatsecret/callback` |
| `app/routers/utils.py` | `/ip` health check |
| `database/init-db.sh` | –°–∫—Ä–∏–ø—Ç —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –ë–î |
| `database/migrations/002_health_tracker_schema.sql` | –ü—Ä–æ–¥–∞–∫—à–Ω —Å—Ö–µ–º–∞ –º—ñ–≥—Ä–∞—Ü—ñ—ó |
| `.env` | –ó–º—ñ–Ω–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è (–ë–î, WHOOP, FatSecret, Telegram, OpenAI) |

---

## 8. TODO / –í—ñ–¥–æ–º—ñ –ø—Ä–æ–±–ª–µ–º–∏

### –ë–≠–ö–õ–û–ì

- [ ] **–®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤** ‚Äî WHOOP/FatSecret —Ç–æ–∫–µ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —è–∫ plain text –≤ –ë–î
- [ ] **BMR –≤ calorie balance** ‚Äî –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ä–º—É–ª—É Mifflin-St Jeor –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –º–µ—Ç–∞–±–æ–ª—ñ–∑–º—É
- [ ] **–í–∏–ø—Ä–∞–≤–∏—Ç–∏ `docs/en/api-integration.md`** ‚Äî –ø—Ä–∏–±—Ä–∞—Ç–∏ `read:cycles`, –¥–æ–¥–∞—Ç–∏ FatSecret OAuth 1.0 vs 2.0
- [ ] **WHOOP –∫—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ API** ‚Äî –ú–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏ WHOOP Developer API –Ω–∞ –ø–æ—è–≤—É –µ–Ω–¥–ø–æ—ñ–Ω—Ç—É –∫—Ä–æ–∫—ñ–≤ (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π —Å—Ç–∞–Ω–æ–º –Ω–∞ 2026-02-25)
- [ ] **–õ–æ–∫–∞–ª—å–Ω–∞ –±–∞–∑–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç—ñ–≤** ‚Äî Fallback –∫–æ–ª–∏ FatSecret –Ω–µ –º–∞—î —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç—ñ–≤

---

## 9. –Ü—Å—Ç–æ—Ä—ñ—è –º—ñ–≥—Ä–∞—Ü—ñ—ó (2026-02-24)

–í—Å—ñ 7 n8n workflows –º—ñ–≥—Ä–æ–≤–∞–Ω–æ –≤ —î–¥–∏–Ω–∏–π FastAPI Python –¥–æ–¥–∞—Ç–æ–∫, workflows –≤–∏–¥–∞–ª–µ–Ω–æ –∑ —Å–µ—Ä–≤–µ—Ä–∞.

### –ú–∞–ø–ø—ñ–Ω–≥ Workflows –Ω–∞ Python

| –ö–æ–ª–∏—à–Ω—ñ–π n8n Workflow | Python –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç |
|---|---|
| WHOOP Data Sync | `app/services/whoop_sync.py` (APScheduler —â–æ–≥–æ–¥–∏–Ω–∏) |
| WHOOP OAuth Callback | `app/routers/whoop.py` ‚Üí `GET /whoop/callback` |
| FatSecret Food Search | `app/services/fatsecret_api.py` ‚Üí `search_food()` |
| FatSecret OAuth Connect | `app/routers/fatsecret.py` ‚Üí `GET /fatsecret/connect` |
| FatSecret OAuth Callback | `app/routers/fatsecret.py` ‚Üí `GET /fatsecret/callback` |
| FatSecret Food Diary | `app/services/fatsecret_api.py` ‚Üí `fetch_food_diary()` |
| IP Check | `app/routers/utils.py` ‚Üí `GET /ip` |

### –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è

Docker –æ–±—Ä–∞–∑: `health-tracker`, —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏–π –Ω–∞ Dokploy.

```bash
docker build -t health-tracker .
docker run --env-file .env -p 8000:8000 health-tracker
```
